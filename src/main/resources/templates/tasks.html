<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Tasks</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="content-padding-top">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand fs-4" href="#">
            <i class="fas fa-tasks me-2"></i> My Tasks
        </a>
        <div class="d-flex">
            <form th:action="@{/logout}" method="post" class="m-0">
                <button type="submit" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <h2 class="text-center text-primary mb-4">Task Management Board</h2>

    <form id="createForm" class="mx-auto" style="max-width: 350px;">
        <div id="new-task-form">
            <h5>Create New Task</h5>
            <input id="title" type="text" class="form-control mb-2" placeholder="Title" required>
            <textarea id="description" class="form-control mb-2" placeholder="Description" maxlength="255"></textarea>
            <input id="deadline" type="date" class="form-control mb-2">

            <select id="priority" class="form-select mb-3" required>
                <option value="" disabled selected>Select priority</option>
                <option th:each="p : ${priorities}"
                        th:value="${p.name()}"
                        th:text="${p.displayName}"></option>
            </select>

            <button type="submit" id="createBtn" class="btn btn-primary w-100">Create</button>
        </div>
    </form>


    <div class="row board">

        <div class="col-12 col-md-6 col-lg-3 column" id="CREATED">
            <h3 th:text="${T(project.ToDoList.entity.Status).CREATED.displayName}"></h3>
            <div th:each="task : ${listTasks}" th:if="${task.status.name() == 'CREATED'}"
                 class="task"
                 th:attr="data-id=${task.id},
                          data-deadline=${task.deadline != null ? #temporals.format(task.deadline, 'yyyy-MM-dd') : ''},
                          data-priority=${task.priority != null ? task.priority.name() : ''}">
                <h5 th:text="${task.title}"></h5>
                <p th:text="${task.description}"></p>
                <div class="task-meta">
                    <span th:if="${task.priority != null}"
                          class="priority-badge" th:classappend="'priority-' + ${task.priority.name()}" th:text="${task.priority.displayName}"></span>
                    <span th:unless="${task.priority != null}"
                          class="priority-badge priority-NONE">No Priority</span>

                    <span th:if="${task.deadline}">Deadline: <span th:text="${#temporals.format(task.deadline, 'dd MMM yyyy')}"></span></span>
                    <span th:unless="${task.deadline}">No Deadline</span> | Created: <span th:text="${#temporals.format(task.createdAt, 'dd MMM yyyy')}"></span>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-sm btn-outline-success btn-small" onclick="changeStatus(this,'IN_PROGRESS')">Start</button>
                    <button class="btn btn-sm btn-outline-primary btn-small" onclick="openEditModal(this)">Edit</button>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3 column" id="IN_PROGRESS">
            <h3 th:text="${T(project.ToDoList.entity.Status).IN_PROGRESS.displayName}"></h3>
            <div th:each="task : ${listTasks}" th:if="${task.status.name() == 'IN_PROGRESS'}"
                 class="task"
                 th:attr="data-id=${task.id},
                          data-deadline=${task.deadline != null ? #temporals.format(task.deadline, 'yyyy-MM-dd') : ''},
                          data-priority=${task.priority != null ? task.priority.name() : ''}">
                <h5 th:text="${task.title}"></h5>
                <p th:text="${task.description}"></p>
                <div class="task-meta">
                    <span th:if="${task.priority != null}"
                          class="priority-badge" th:classappend="'priority-' + ${task.priority.name()}" th:text="${task.priority.displayName}"></span>
                    <span th:unless="${task.priority != null}"
                          class="priority-badge priority-NONE">No Priority</span>

                    <span th:if="${task.deadline}">Deadline: <span th:text="${#temporals.format(task.deadline, 'dd MMM yyyy')}"></span></span>
                    <span th:unless="${task.deadline}">No Deadline</span> | Updated: <span th:text="${#temporals.format(task.updatedAt, 'dd MMM yyyy')}"></span>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-sm btn-outline-success btn-small" onclick="changeStatus(this,'COMPLETED')">Complete</button>
                    <button class="btn btn-sm btn-outline-primary btn-small" onclick="openEditModal(this)">Edit</button>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3 column" id="OVERDUE">
            <h3 th:text="${T(project.ToDoList.entity.Status).OVERDUE.displayName}"></h3>
            <div th:each="task : ${listTasks}" th:if="${task.status.name() == 'OVERDUE'}"
                 class="task"
                 th:attr="data-id=${task.id},
                          data-deadline=${task.deadline != null ? #temporals.format(task.deadline, 'yyyy-MM-dd') : ''},
                          data-priority=${task.priority != null ? task.priority.name() : ''}">
                <h5 th:text="${task.title}"></h5>
                <p th:text="${task.description}"></p>
                <div class="task-meta">
                    <span th:if="${task.priority != null}"
                          class="priority-badge" th:classappend="'priority-' + ${task.priority.name()}" th:text="${task.priority.displayName}"></span>
                    <span th:unless="${task.priority != null}"
                          class="priority-badge priority-NONE">No Priority</span>

                    <span th:if="${task.deadline}">Overdue since: <span th:text="${#temporals.format(task.deadline, 'dd MMM yyyy')}"></span></span>
                    <span th:unless="${task.deadline}">No Deadline</span>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-sm btn-outline-success btn-small" onclick="changeStatus(this,'IN_PROGRESS')">Resume</button>
                    <button class="btn btn-sm btn-outline-primary btn-small" onclick="openEditModal(this)">Edit</button>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3 column" id="COMPLETED">
            <h3 th:text="${T(project.ToDoList.entity.Status).COMPLETED.displayName}"></h3>
            <div th:each="task : ${listTasks}" th:if="${task.status.name() == 'COMPLETED'}"
                 class="task"
                 th:attr="data-id=${task.id},
                          data-deadline=${task.deadline != null ? #temporals.format(task.deadline, 'yyyy-MM-dd') : ''},
                          data-priority=${task.priority != null ? task.priority.name() : ''}">
                <h5 th:text="${task.title}"></h5>
                <p th:text="${task.description}"></p>
                <div class="task-meta">
                    <span th:if="${task.priority != null}"
                          class="priority-badge" th:classappend="'priority-' + ${task.priority.name()}" th:text="${task.priority.displayName}"></span>
                    <span th:unless="${task.priority != null}"
                          class="priority-badge priority-NONE">No Priority</span>

                    Completed: <span th:text="${#temporals.format(task.updatedAt, 'dd MMM yyyy')}"></span>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <button class="btn btn-sm btn-outline-secondary btn-small" onclick="changeStatus(this,'INACTIVE')">Archive</button>
                    <button class="btn btn-sm btn-outline-primary btn-small" onclick="openEditModal(this)">Edit</button>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3 column" id="INACTIVE">
            <h3 th:text="${T(project.ToDoList.entity.Status).INACTIVE.displayName}"></h3>
            <div th:each="task : ${listTasks}" th:if="${task.status.name() == 'INACTIVE'}"
                 class="task"
                 th:attr="data-id=${task.id},
                          data-deadline=${task.deadline != null ? #temporals.format(task.deadline, 'yyyy-MM-dd') : ''},
                          data-priority=${task.priority != null ? task.priority.name() : ''}">
                <h5 th:text="${task.title}"></h5>
                <p th:text="${task.description}"></p>
                <div class="task-meta">
                    <span th:if="${task.priority != null}"
                          class="priority-badge" th:classappend="'priority-' + ${task.priority.name()}" th:text="${task.priority.displayName}"></span>
                    <span th:unless="${task.priority != null}"
                          class="priority-badge priority-NONE">No Priority</span>

                    Archived: <span th:text="${#temporals.format(task.updatedAt, 'dd MMM yyyy')}"></span>
                </div>
                <button class="btn btn-sm btn-outline-danger btn-small" onclick="deleteTask(this)">Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <input type="text" id="editTitle" class="form-control mb-2" placeholder="Title" required>
                    <textarea id="editDescription" class="form-control mb-2" placeholder="Description" maxlength="255"></textarea>
                    <input type="date" id="editDeadline" class="form-control mb-2">

                    <select id="editPriority" class="form-select mb-2" required>
                        <option value="" disabled selected>Select priority</option>
                        <option th:each="p : ${priorities}"
                                th:value="${p.name()}"
                                th:text="${p.displayName}"></option>
                    </select>

                    <select id="editStatus" class="form-select mb-2">
                        <option th:each="s : ${statuses}"
                                th:value="${s.name()}"
                                th:text="${s.displayName}"></option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // === CREATE TASK - Form Submission Handler ===
    document.getElementById("createForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = {
            title: document.getElementById("title").value,
            description: document.getElementById("description").value,
            deadline: document.getElementById("deadline").value,
            priority: document.getElementById("priority").value
        };

        const res = await fetch("/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (res.ok) location.reload();
        else alert("Failed to create task");
    });

    // === CHANGE STATUS ===
    async function changeStatus(btn, newStatus) {
        const taskElement = btn.closest(".task");
        if (!taskElement) {
            console.error("Task element not found.");
            return;
        }
        const id = taskElement.dataset.id;

        const form = new FormData();
        form.append("status", newStatus);

        const res = await fetch(`/${id}/status`, { method: "POST", body: form });

        if (res.ok) location.reload();
        else {
            const errorText = await res.text();
            alert(`Failed to update status. Server response: ${res.status} ${errorText.substring(0, 100)}...`);
        }
    }

    // === DELETE TASK ===
    async function deleteTask(btn) {
        const id = btn.closest(".task").dataset.id;
        if (!confirm("Are you sure you want to delete this task? Task must be in Inactive status.")) return;

        const res = await fetch(`/${id}/delete`, { method: "POST" });
        if (res.ok) location.reload();
        else alert("Failed to delete. Task must be in Inactive status.");
    }

    // === EDIT TASK MODAL HANDLERS ===
    const modal = new bootstrap.Modal(document.getElementById("editModal"));

    function openEditModal(btn) {
        const task = btn.closest(".task");

        // Set basic data
        document.getElementById("editId").value = task.dataset.id;
        document.getElementById("editTitle").value = task.querySelector("h5").innerText;
        document.getElementById("editDescription").value = task.querySelector("p").innerText;

        // Set deadline date (YYYY-MM-DD)
        const deadlineValue = task.dataset.deadline;
        // Since data-deadline is already in 'YYYY-MM-DD' format, we use it directly.
        document.getElementById("editDeadline").value = deadlineValue;

        // Set priority
        const priorityValue = task.dataset.priority;
        document.getElementById("editPriority").value = priorityValue ? priorityValue : '';

        // Set the status based on the column ID
        const currentColumnId = task.closest(".column").id;
        document.getElementById("editStatus").value = currentColumnId; // Column ID matches Status name (e.g., 'CREATED')

        modal.show();
    }

    document.getElementById("editForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = document.getElementById("editId").value;
        const data = {
            title: document.getElementById("editTitle").value,
            description: document.getElementById("editDescription").value,
            deadline: document.getElementById("editDeadline").value,
            status: document.getElementById("editStatus").value,
            priority: document.getElementById("editPriority").value
        };

        const res = await fetch(`/${id}/edit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (res.ok) location.reload();
        else alert("Failed to edit task");
    });
</script>
</body>
</html>